<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steady Starry Night — Ask</title>
<style>
  *{box-sizing:border-box}
  body{
    margin:0;
    background:#2A2B2D;
    color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
  }
  main{
    min-height:100svh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
  }
  .card{
    width:100%;
    max-width:720px;
    background:#2A2B2D;
    border:1px solid #444;
    border-radius:16px;
    padding:28px;
    box-shadow:0 8px 28px rgba(0,0,0,.4);
    text-align:center;
  }
  .title{ margin-bottom:20px; }
  .title .icon svg{
    width:30px;
    height:30px;
    fill:#fff;
    display:block;
    margin:0 auto 12px;
  }
  h1{
    font-size:22px;
    font-weight:700;
    margin:0;
    color:#fff;
  }
  #q{
    font-size:20px;
    line-height:1.7;
    margin:12px 0 4px;
    word-break:keep-all;
    color:#fff;
  }
  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:16px;
  }
  button{
    padding:10px 14px;
    border-radius:10px;
    border:1px solid #555;
    background:#3A3B3D;
    color:#fff;
    cursor:pointer;
    font-size:14px;
  }
  button:active{ transform:translateY(1px); }
  .meta{
    opacity:.8;
    font-size:13px;
    margin-top:14px;
    color:#ddd;
  }
</style>

<main>
  <div class="card">
    <div class="title">
      <div class="icon">
        <!-- 인라인 SVG (30px 크기로 표시됨) -->
        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path d="M42.1561 21.5819C40.6996 20.6914 32.4461 20.6532 31.8967 17.5364C31.6795 15.73 32.676 14.2161 33.6343 12.7022C34.5797 11.3028 36.9306 7.63902 33.6215 10.0689C31.6028 11.3537 29.8524 13.9744 27.936 15.2465C23.7964 16.0353 16.9994 12.6259 13.2431 9.6872C12.1954 9.01296 11.4927 8.80941 12.3615 10.247C14.6102 13.5927 17.3188 17.4601 20.9345 16.7859C26.5817 15.9208 19.5163 20.1062 19.0436 21.6201C18.9797 21.8872 19.1203 22.0272 19.3886 22.0526C20.3723 22.1035 21.7777 21.7855 21.7266 23.1594C21.7905 24.4697 21.8289 26.1871 21.2922 26.1744C19.7974 25.7292 16.6161 23.8082 16.6289 21.989C16.5777 20.755 17.4849 19.5973 16.2072 19.432C14.5591 19.3938 7.16152 20.5006 6.04997 21.4165C5.18118 22.8922 15.9261 23.0067 16.0795 26.3907C16.4372 28.9859 12.2338 32.5607 11.5949 35.0668C13.0898 34.3926 14.1502 33.0823 15.5429 32.1281C25.0485 25.004 22.7871 38.667 23.937 43.8447..." />
        </svg>
      </div>
      <h1>오늘의 별무리</h1>
    </div>

    <p id="q">불러오는 중…</p>

    <div class="row">
      <button id="again">다른 생각거리 뽑기</button>
      <button id="share">질문 복사/공유</button>
    </div>

    <div class="meta">
      하루를 갈무리하며 생각해 볼 거리와 질문이 랜덤으로 나타납니다.  
      천천히 사유와 함께 별을 접어보세요.
    </div>
  </div>
</main>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSomhMVou4ceevX5Z4I9CfhA7o1jKNw_oFuimodzuRvcZjc3M_bR_jdD7pkXXwT-hueaneC0p61aDje/pub?gid=1707499206&single=true&output=csv";

  function parseCSV(text){
    const rows=[], cur=[]; let cell="", q=false;
    const pushCell=()=>{ cur.push(cell); cell=""; };
    const pushRow=()=>{ rows.push(cur.slice()); cur.length=0; };
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(q){
        if(ch==='"'){ if(text[i+1]==='"'){ cell+='"'; i++; } else q=false; }
        else cell+=ch;
      }else{
        if(ch==='"') q=true;
        else if(ch===',') pushCell();
        else if(ch==='\n'){ pushCell(); pushRow(); }
        else if(ch!=='\r') cell+=ch;
      }
    }
    if(cell.length||cur.length){ pushCell(); pushRow(); }
    return rows.filter(r=>r.some(c=>(c||"").trim()!==""));
  }

  function toObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h=>h.replace(/^\uFEFF/,'').trim());
    return rows.slice(1).map(r=>{
      const o={}; headers.forEach((h,i)=>o[h]=(r[i]??"").trim()); return o;
    });
  }

  function pickQuestionKey(headers, data){
    const Q_CAND = ["Question","질문","question","내용","text"];
    let idx = headers.findIndex(h=>Q_CAND.includes(h) || Q_CAND.includes(h.toLowerCase()));
    if(idx>=0) return headers[idx];
    let best = 0, bestKey = headers[0]||"";
    headers.forEach(h=>{
      const count = data.filter(row => (row[h]||"").trim()).length;
      if(count>best){ best=count; bestKey=h; }
    });
    return bestKey;
  }

  let DATA=[], QKEY="";

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
  function render(item){ document.getElementById("q").textContent = item || "(질문 없음)"; }
  function loadRandom(){ render(pick(DATA)); }

  (async () => {
    try{
      const res = await fetch(CSV_URL,{cache:"no-store"});
      const text = await res.text();
      const rows = parseCSV(text);
      const objs = toObjects(rows);
      const headers = Object.keys(objs[0]||{});
      QKEY = pickQuestionKey(headers, objs);
      DATA = objs.map(o => (o[QKEY]||"").trim()).filter(Boolean);
    }catch(e){
      DATA = ["오늘 하루를 별에 비유한다면?"];
    }
    loadRandom();
  })();

  document.getElementById("again").addEventListener("click", loadRandom);
  document.getElementById("share").addEventListener("click", async () => {
    const q = document.getElementById("q").textContent.trim();
    const txt = `⭐ 오늘의 별무리\n\n${q}`;
    if(navigator.share){ try{ await navigator.share({ text: txt }); return; }catch{} }
    try{ await navigator.clipboard.writeText(txt); alert("질문이 복사되었어요!"); }
    catch{ alert("복사/공유를 지원하지 않는 환경입니다."); }
  });
</script>
